---
title: "Sim_study_output"
author: "Florian van Leeuwen"
date: "2023-02-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = F, warning =F}
library(haven)
library(dplyr)
library(xtable)
library(simstudy)
library(lme4)
library(ggplot2)
library(tidyr)
library(patchwork)
```

```{r}
# Own functions
source("functions/1.Generate_data.R")
source("functions/2.Models.R")
source("functions/3.sim_all.R")
```

In this case formula's are generated for a case where we have 10 timepoints, with a staring intercept of 170 and a slope of 12.7. The change in intercept is added after the intervention which happens in the middle of the time series, the value here is 4. The change in slope is set to 4.

```{r}
X <- forms_for_sim(N_time = 10, var = 20, Intercept =170,  Slope = 12.7, step_size = 20,slope_size =  40)
X
```

```{r, warning = F}
test <- gen_data(X$form, X$v_name, X$var, N_person = 100, X$Intercept, var_time = 10)
test 

# inspect data
test %>% 
  ggplot(aes(y = score, x = time, color = as.factor(id))) +
  geom_point(alpha = .7, size = .4) +
  geom_smooth(se = F, size = .5) +
  guides(color = FALSE)
```

In the output of the table we can see that person i has 10 scores. The column value is the score without variance and the column score is with variance. There is a treatment dummy and a variable for time. In the figure we can see the generated data points for n = 100. 

```{r}
# define input
N_person <- c(100, 200, 300, 400, 500, 600)
N_time <- c(6, 8, 10, 12, 14, 16, 18)
N_sim <- 100
var <- 25
Intercept <- 170
Slope <- 12.7
step_size <- -3
seed <- 123
slope_size <-  -1
var_time <- 10

startTime <- Sys.time()
out <- sim_all(N_person, N_time, N_sim, var, Intercept, Slope, step_size, slope_size, seed, var_time, model = "OLS")
endTime <- Sys.time()

out
print(endTime - startTime)
```

```{r}
# write away the results
write.csv(out, "results/sim_OLS1")
```

```{r}
# heat maps
P1 <- out %>% 
  ggplot(aes(x = N_t, y = N_pers, fill = pre_slope)) +
  geom_tile() + 
  labs(title = "Power for pre slope",x = "Number of time points",
       y = "Number of participants", fill="Power") +
  theme_minimal()

P2 <- out %>% 
  ggplot(aes(x = N_t, y = N_pers, fill = step)) +
  geom_tile() + 
  labs(title = "Power for step change",x = "Number of time points",
       y = "Number of participants", fill="Power") +
  theme_minimal()

P3 <- out %>% 
  ggplot(aes(x = N_t, y = N_pers, fill = slope)) +
  geom_tile() + 
  labs(title = "Power for step change", x = "Number of time points",
       y = "Number of participants", fill="Power") +
  theme_minimal()

B1 <- out %>% 
  ggplot(aes(x = N_t, y = N_pers, fill = bias_pre_slope)) +
  geom_tile() + 
  labs(title = "Percentage bias in pre slope", x = "Number of time points", 
       y = "Number of participants", fill="Percentage bias") +
  theme_minimal()

B2 <- out %>% 
  ggplot(aes(x = N_t, y = N_pers, fill = bias_step)) +
  geom_tile() + 
  labs(title = "Percentage bias in step change", x = "Number of time points", 
       y = "Number of participants", fill="Percentage bias") +
  theme_minimal()

B3 <- out %>% 
  ggplot(aes(x = N_t, y = N_pers, fill = bias_slope)) +
  geom_tile() + 
  labs("Percentage bias in slope change", x = "Number of time points",
       y = "Number of participants", fill="Percentage bias") +
  theme_minimal()
```

```{r}
# inspect the plots
P1 + P2 + P3

B1 + B2 + B3
```
```{r}
# figure of the sim studie
time <- rep(seq(10),3)
group <- c(rep("Step", 10), rep("Slope", 10), rep("Step and slope", 10))
score1 <- time * 2 + c(rep(0,5), rep(-2,5), rep(0,5), -0.5, -1.2, -2.2, -3.2, -4.2, rep(0, 5), 
                       -3, -4.5, -6, -7.5, -9)

data_eex <- data.frame(time = time, 
            group = group,
            score = score1)

data_eex %>% 
  ggplot(aes(x = time, y = score)) +
  geom_point() +
  geom_segment(aes(x = 1, y = 2, xend = 5.5, yend = 11, color = "General trend")) +
  geom_segment(aes(x = 5.5, y = 9, xend = 10, yend = 18, color = "Step")) +
  geom_segment(aes(x = 5.5, y = 11, xend = 10, yend = 16, color = "Slope")) +
  geom_segment(aes(x = 5.5, y = 8.75, xend = 10, yend = 11, color = "Step and slope")) +
  scale_color_discrete(name="Changing parameter") +
  labs(title = "The different simulation scenarios", y = "Score", x = "Time") +
  geom_vline(xintercept = 5.5) +
  scale_x_continuous("Time", labels=c("T_0", "(N+1)/2", "T_N"), breaks=c(1, 5.5, 10))

```

